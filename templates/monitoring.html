<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ strings.monitoring_title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #0f0f23;
            color: #f7fafc;
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
        }
        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #cbd5f5;
        }
        .metric-value {
            font-size: 1.3rem;
            font-weight: 600;
        }
        .heatmap-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .heatmap-row span {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 4px;
            border-radius: 2px;
            background: #2d3748;
        }
        .heatmap-label {
            width: 60px;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #a0aec0;
        }
        .table-dark {
            --bs-table-bg: rgba(255, 255, 255, 0.04);
            --bs-table-striped-bg: rgba(255, 255, 255, 0.07);
            color: #f7fafc;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">{{ strings.monitoring_title }}</h1>
                <p class="text-muted mb-0">{{ strings.monitoring_subtitle }}</p>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-light" href="/" role="button">&larr; Back to Tracker</a>
            </div>
        </div>

        <div id="healthCards" class="row g-4"></div>

        <div class="row g-4 mt-1">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">{{ strings.monitoring_drawdown_label }}</h5>
                        </div>
                        <canvas id="equityChart" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">{{ strings.monitoring_accuracy_label }}</h5>
                        </div>
                        <div id="accuracyHeatmap"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">{{ strings.monitoring_card_cv }}</h5>
                    <small class="text-muted" id="cvUpdated"></small>
                </div>
                <canvas id="cvChart" height="120"></canvas>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">{{ strings.monitoring_walkforward_label }}</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Exchange</th>
                                <th>Family</th>
                                <th>Segment</th>
                                <th>Accuracy</th>
                                <th>Macro F1</th>
                                <th>Optuna Score</th>
                            </tr>
                        </thead>
                        <tbody id="walkForwardTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function loadHealth() {
            const res = await fetch('/monitoring/api/model-health');
            const data = await res.json();
            renderHealthCards(data);
            renderCvChart(data);
            renderEquityChart(data);
            renderAccuracyHeatmap(data);
            renderWalkForwardTable(data);
        }

        function renderHealthCards(data) {
            const container = document.getElementById('healthCards');
            const entries = Object.entries(data);
            if (!entries.length) {
                container.innerHTML = '<p class="text-muted">No diagnostics found.</p>';
                return;
            }

            container.innerHTML = entries.map(([exchange, report]) => {
                const training = report.training || {};
                const targetDist = training.target_stats || {};
                const optuna = training.optuna_params || {};
                const cv = training.cv_results || [];
                const auto = report.auto_ml || {};
                const backtest = report.backtest || {};
                const online = report.online_learning || {};
                const bestFamily = summarizeBestFamily(auto.best_by_family);
                const netPnL = backtest.metrics ? (backtest.metrics.net_total_pnl || 0) : 0;
                const sharpe = backtest.metrics ? (backtest.metrics.sharpe_ratio || 0) : 0;
                const rollingAcc = online.rolling_accuracy ? (online.rolling_accuracy * 100).toFixed(1) : '—';

                return `
                    <div class="col-12 col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">${exchange}</h5>
                                    <small class="text-muted">{{ strings.monitoring_updated_label }}: ${cv.length ? cv.length + ' folds' : 'No CV data'}</small>
                                </div>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="metric-label">{{ strings.monitoring_card_target }}</div>
                                        <div class="metric-value">${formatDistribution(targetDist)}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-label">{{ strings.monitoring_card_optuna }}</div>
                                        <div class="metric-value">${Object.keys(optuna).length ? formatOptuna(optuna) : '—'}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-label">{{ strings.monitoring_card_auto_ml }}</div>
                                        <div class="metric-value">${bestFamily}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-label">{{ strings.monitoring_card_backtest }}</div>
                                        <div class="metric-value">PnL ₹${netPnL.toFixed(0)} · Sharpe ${sharpe.toFixed(2)}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-label">{{ strings.monitoring_card_online }}</div>
                                        <div class="metric-value">${rollingAcc === '—' ? '—' : rollingAcc + '%'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCvChart(data) {
            const labels = [];
            const datasets = [];
            Object.entries(data).forEach(([exchange, report]) => {
                const training = report.training || {};
                const cv = training.cv_results || [];
                if (!cv.length) return;
                const exchangeLabels = cv.map(fold => `F${fold.fold}`);
                if (labels.length < exchangeLabels.length) {
                    labels.length = 0;
                    labels.push(...exchangeLabels);
                }
                datasets.push({
                    label: `${exchange} Accuracy`,
                    data: cv.map(fold => (fold.accuracy || 0) * 100),
                    borderWidth: 2,
                    fill: false
                });
                const cvUpdated = document.getElementById('cvUpdated');
                if (cvUpdated) {
                    cvUpdated.textContent = `${exchange} folds: ${cv.length}`;
                }
            });

            if (!datasets.length) {
                const ctx = document.getElementById('cvChart').getContext('2d');
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#a0aec0';
                ctx.fillText('No CV data available', 20, 40);
                return;
            }

            new Chart(document.getElementById('cvChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            ticks: { color: '#cbd5f5', callback: value => value + '%' },
                            beginAtZero: true,
                            max: 100
                        },
                        x: { ticks: { color: '#cbd5f5' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#f7fafc' } }
                    }
                }
            });
        }

        function renderEquityChart(data) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            const datasets = [];
            let labels = [];
            Object.entries(data).forEach(([exchange, report]) => {
                const equity = (report.backtest && report.backtest.equity_curve) || [];
                if (!equity.length) return;
                const exchangeLabels = equity.map(point => point.timestamp);
                if (!labels.length || exchangeLabels.length > labels.length) {
                    labels = exchangeLabels;
                }
                datasets.push({
                    label: `${exchange} Net Equity`,
                    data: equity.map(point => point.net_equity),
                    borderWidth: 2,
                    fill: false,
                });
                datasets.push({
                    label: `${exchange} Gross Equity`,
                    data: equity.map(point => point.gross_equity),
                    borderDash: [4, 2],
                    borderWidth: 1,
                    fill: false,
                });
            });
            if (!datasets.length) {
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#a0aec0';
                ctx.fillText('Run a backtest via backtesting/run.py to populate equity curves.', 20, 40);
                return;
            }
            new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            ticks: { color: '#cbd5f5', callback: value => '₹' + value },
                            beginAtZero: true,
                        },
                        x: { ticks: { color: '#cbd5f5' } }
                    },
                    plugins: { legend: { labels: { color: '#f7fafc' } } }
                }
            });
        }

        function renderAccuracyHeatmap(data) {
            const container = document.getElementById('accuracyHeatmap');
            const rows = Object.entries(data).map(([exchange, report]) => {
                const history = (report.online_learning && report.online_learning.accuracy_history) || [];
                if (!history.length) {
                    return `
                        <div class="heatmap-row">
                            <div class="heatmap-label">${exchange}</div>
                            <span style="width:auto;color:#a0aec0">No feedback yet</span>
                        </div>`;
                }
                const boxes = history.map(value => {
                    const pct = (value * 100).toFixed(1);
                    return `<span style="background:${accuracyColor(value)}" title="${pct}%"></span>`;
                }).join('');
                return `
                    <div class="heatmap-row">
                        <div class="heatmap-label">${exchange}</div>
                        <div>${boxes}</div>
                    </div>`;
            }).join('');
            container.innerHTML = rows;
        }

        function renderWalkForwardTable(data) {
            const body = document.getElementById('walkForwardTable');
            const rows = [];
            Object.entries(data).forEach(([exchange, report]) => {
                const bestFamilies = (report.auto_ml && report.auto_ml.best_by_family) || {};
                Object.entries(bestFamilies).forEach(([family, entry]) => {
                    const metrics = entry.metrics || {};
                    rows.push(`
                        <tr>
                            <td>${exchange}</td>
                            <td>${family}</td>
                            <td>${entry.segment_id || '—'}</td>
                            <td>${formatPercent(metrics.accuracy)}</td>
                            <td>${formatPercent(metrics.f1_macro)}</td>
                            <td>${entry.optuna_score ? entry.optuna_score.toFixed(3) : '—'}</td>
                        </tr>
                    `);
                });
            });
            body.innerHTML = rows.length ? rows.join('') : `
                <tr>
                    <td colspan="6" class="text-muted">Run train_orchestrator.py to populate walk-forward results.</td>
                </tr>`;
        }

        function formatDistribution(dist) {
            if (!dist || !Object.keys(dist).length) return '—';
            return Object.entries(dist)
                .map(([key, val]) => `${key}: ${(val * 100).toFixed(1)}%`)
                .join(' · ');
        }

        function formatOptuna(params) {
            return Object.entries(params)
                .map(([k, v]) => `${k}=${typeof v === 'number' ? v.toFixed(2) : v}`)
                .join(', ');
        }

        function formatPercent(value) {
            if (typeof value !== 'number' || isNaN(value)) return '—';
            return (value * 100).toFixed(1) + '%';
        }

        function summarizeBestFamily(bestByFamily = {}) {
            const entries = Object.entries(bestByFamily);
            if (!entries.length) return '—';
            const best = entries
                .map(([family, meta]) => ({ family, f1: (meta.metrics && meta.metrics.f1_macro) || 0 }))
                .sort((a, b) => b.f1 - a.f1)[0];
            return `${best.family} ${(best.f1 * 100).toFixed(1)}%`;
        }

        function accuracyColor(value) {
            if (typeof value !== 'number' || isNaN(value)) return '#2d3748';
            const hue = 10 + (value * 100) * 1.2; // approx green for higher accuracy
            return `hsl(${Math.min(140, hue)}, 70%, 45%)`;
        }

        document.addEventListener('DOMContentLoaded', loadHealth);
    </script>
</body>
</html>

